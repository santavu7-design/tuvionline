<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L√° S·ªë T·ª≠ Vi - Ch√≠nh</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        .header h1 {
            font-size: 2.5em;
            margin: 0;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .welcome-section {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-radius: 20px;
            margin-bottom: 30px;
        }
        .welcome-title {
            font-size: 2em;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .user-info {
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            font-size: 1.2em;
            color: #2c3e50;
        }
        .today-info {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #f39c12;
        }
        .today-date, .today-lunar, .today-canchi {
            margin: 10px 0;
            font-size: 1.1em;
            color: #2c3e50;
        }
        .form-section {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: none;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        button:hover {
            background: #45a049;
        }
        .submit-btn {
            background: #667eea;
        }
        .submit-btn:hover {
            background: #5a6fd8;
        }
        .mock-btn {
            background: #ff6b6b;
        }
        .mock-btn:hover {
            background: #ff5252;
        }
        .laso-btn, .form-btn {
            background: #667eea;
            margin: 10px;
            padding: 15px 30px;
            font-size: 18px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .result-section {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: none;
        }
        .fortune-section {
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .date-picker {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .date-picker input[type="text"] {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            width: 150px;
        }
        .fortune-btn {
            background: #9c27b0;
        }
        .fortune-btn:hover {
            background: #7b1fa2;
        }
        .today-btn {
            background: #ff9800;
        }
        .today-btn:hover {
            background: #f57c00;
        }
        .home-btn {
            background: #607d8b;
        }
        .home-btn:hover {
            background: #455a64;
        }
        .log {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .info { color: #74c0fc; }
        .warning { color: #ffd43b; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîÆ L√° S·ªë T·ª≠ Vi</h1>
        </div>

        <!-- Welcome Section -->
        <div id="welcome" class="welcome-section">
            <div class="welcome-title">Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi T·ª≠ Vi H·ªçc</div>
            <div id="userInfo" class="user-info"></div>
            <div id="todayInfo" class="today-info">
                <div id="todayDate" class="today-date"></div>
                <div id="todayLunar" class="today-lunar"></div>
                <div id="todayCanChi" class="today-canchi"></div>
            </div>
            <div class="fortune-section">
                <h3>üîÆ Xem T·ª≠ Vi Ng√†y</h3>
                <div class="date-picker">
                    <label for="fortune_date_display">Ch·ªçn ng√†y (dd/mm/yyyy):</label>
                    <input type="text" id="fortune_date_display" placeholder="dd/mm/yyyy">
                    <button class="fortune-btn" onclick="checkDailyFortune()">üîÆ Xem T·ª≠ Vi Ng√†y N√†y</button>
                    <button class="fortune-btn today-btn" onclick="checkDailyFortuneToday()">üîÆ Xem Ng√†y H√¥m Nay T·ªët Hay X·∫•u</button>
                </div>
            </div>
            <button class="laso-btn" onclick="showMyLaso()">üìä Xem L√° S·ªë C·ªßa T√¥i</button>
            <button class="form-btn" onclick="showForm()">‚úèÔ∏è T·∫°o L√° S·ªë M·ªõi</button>
        </div>

        <!-- Input Form -->
        <div id="form" class="form-section">
            <form id="lasoForm">
                <div class="form-group">
                    <label for="name">H·ªç v√† T√™n:</label>
                    <input type="text" id="name" value="Ho√†ng Anh" required>
                </div>
                <div class="form-group">
                    <label for="gender">Gi·ªõi T√≠nh:</label>
                    <select id="gender" required>
                        <option value="Nam" selected>Nam</option>
                        <option value="N·ªØ">N·ªØ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="dob_display">Ng√†y Sinh D∆∞∆°ng L·ªãch (dd/mm/yyyy):</label>
                    <input type="text" id="dob_display" placeholder="dd/mm/yyyy" value="19/11/1990" required>
                </div>
                <div class="form-group">
                    <label for="time">Gi·ªù Sinh (24h):</label>
                    <input type="text" id="time" value="08:30" required>
                </div>
                <div class="form-group">
                    <label for="birthPlace">N∆°i Sinh:</label>
                    <input type="text" id="birthPlace" value="H√† N·ªôi" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="submit-btn">üîÆ T·∫°o L√° S·ªë T·ª≠ Vi</button>
                    <button type="button" class="mock-btn" onclick="generateMockData()">üé≤ T·∫°o D·ªØ Li·ªáu Gi·∫£</button>
                </div>
            </form>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>ƒêang t·∫°o l√° s·ªë t·ª≠ vi...</p>
        </div>

        <!-- Result -->
        <div id="result" class="result-section">
            <div id="content"></div>
            <button class="home-btn" onclick="showWelcomeScreen()">üè† V·ªÅ Trang Ch·ªß</button>
        </div>

        <!-- Fortune Result -->
        <div id="fortuneResult" class="fortune-section" style="display: none;">
            <div id="fortuneContent"></div>
            <button class="home-btn" onclick="showWelcomeScreen()">üè† V·ªÅ Trang Ch·ªß</button>
        </div>

        <!-- Log -->
        <div id="log" class="log"></div>
    </div>

    <script>
        // Global variables
        let userData = null;
        let currentData = null;

        // API Configuration
        const API_KEYS = [
            'AIzaSyAlst5yeNQebSyfxUMRY6yDK7lvwKMUzLM',
            'AIzaSyAxs5Y8I2wBENa3ZaE45iK5jxdvWpn-Pjs'
        ];

        const GEMINI_MODELS = [
            'gemini-1.5-flash',
            'gemini-1.5-pro',
            'gemini-pro'
        ];

        // Date helper functions
        function formatDateToDDMMYYYY(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function parseDateFromDDMMYYYY(dateString) {
            if (!dateString) return null;
            
            const parts = dateString.split('/');
            if (parts.length !== 3) return null;
            
            const day = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1;
            const year = parseInt(parts[2]);
            
            if (isNaN(day) || isNaN(month) || isNaN(year)) return null;
            
            const date = new Date(year, month, day);
            
            // Validate the date
            if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day) {
                return date;
            }
            return null;
        }

        // Calculate lunar date info
        function calculateLunarDateInfo(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            
            // Simple lunar calculation (this is a simplified version)
            const lunarDate = `√Çm l·ªãch: ${day}/${month}/${year}`;
            const canChi = `Can Chi: ${year % 10 === 0 ? 'Canh' : year % 10 === 1 ? 'T√¢n' : year % 10 === 2 ? 'Nh√¢m' : year % 10 === 3 ? 'Qu√Ω' : year % 10 === 4 ? 'Gi√°p' : year % 10 === 5 ? '·∫§t' : year % 10 === 6 ? 'B√≠nh' : year % 10 === 7 ? 'ƒêinh' : year % 10 === 8 ? 'M·∫≠u' : 'K·ª∑'} ${year % 12 === 0 ? 'Th√¢n' : year % 12 === 1 ? 'D·∫≠u' : year % 12 === 2 ? 'Tu·∫•t' : year % 12 === 3 ? 'H·ª£i' : year % 12 === 4 ? 'T√Ω' : year % 12 === 5 ? 'S·ª≠u' : year % 12 === 6 ? 'D·∫ßn' : year % 12 === 7 ? 'M√£o' : year % 12 === 8 ? 'Th√¨n' : year % 12 === 9 ? 'T·ªµ' : year % 12 === 10 ? 'Ng·ªç' : 'M√πi'}`;
            
            return {
                dateStr: `${day}/${month}/${year}`,
                lunarDate: lunarDate,
                canChi: canChi
            };
        }

        // Log function
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            logDiv.textContent += logEntry;
            logDiv.style.display = 'block';
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Show welcome screen
        function showWelcomeScreen() {
            const today = new Date();
            const dateInfo = calculateLunarDateInfo(today);
            
            document.getElementById('todayDate').textContent = `D∆∞∆°ng l·ªãch: ${dateInfo.dateStr}`;
            document.getElementById('todayLunar').textContent = dateInfo.lunarDate;
            document.getElementById('todayCanChi').textContent = dateInfo.canChi;
            
            if (userData) {
                document.getElementById('userInfo').innerHTML = `
                    <h3>Xin ch√†o ${userData.name}!</h3>
                    <p>Ng√†y sinh: ${formatDateToDDMMYYYY(userData.dob)} ${userData.time}</p>
                    <p>N∆°i sinh: ${userData.birthPlace}</p>
                `;
            }
            
            document.getElementById('welcome').style.display = 'block';
            document.getElementById('form').style.display = 'none';
            document.getElementById('result').style.display = 'none';
            document.getElementById('fortuneResult').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
        }

        // Show form
        function showForm() {
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('form').style.display = 'block';
            document.getElementById('result').style.display = 'none';
            document.getElementById('fortuneResult').style.display = 'none';
        }

        // Show my laso
        function showMyLaso() {
            if (!currentData) {
                alert('Ch∆∞a c√≥ l√° s·ªë t·ª≠ vi. Vui l√≤ng t·∫°o l√° s·ªë tr∆∞·ªõc!');
                return;
            }
            
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('form').style.display = 'none';
            document.getElementById('result').style.display = 'block';
            document.getElementById('fortuneResult').style.display = 'none';
            
            displayLasoData(currentData.rawMarkdown);
        }

        // Generate laso with Gemini API
        async function generateLaso(userData) {
            const dob = userData.dob;
            const day = String(dob.getDate()).padStart(2, '0');
            const month = String(dob.getMonth() + 1).padStart(2, '0');
            const year = dob.getFullYear();
            
            const prompt = `B·∫°n l√† m·ªôt chuy√™n gia t·ª≠ vi h·ªçc Vi·ªát Nam v·ªõi ki·∫øn th·ª©c s√¢u r·ªông v·ªÅ thu·∫≠t t·ª≠ vi c·ªï truy·ªÅn. H√£y t·∫°o m·ªôt l√° s·ªë t·ª≠ vi chi ti·∫øt v√† huy·ªÅn b√≠ cho ng∆∞·ªùi d√πng d·ª±a tr√™n th√¥ng tin sau:

H·ªç v√† T√™n: ${userData.name}
Gi·ªõi T√≠nh: ${userData.gender}
Ng√†y Sinh D∆∞∆°ng L·ªãch: ${day}/${month}/${year} ${userData.time}
N∆°i Sinh: ${userData.birthPlace}

**Y√äU C·∫¶U ƒê·∫∂C BI·ªÜT QUAN TR·ªåNG:**
1. H√£y KI·ªÇM TRA TH·∫¨T K·ª∏ t·ª´ng th√¥ng tin tr∆∞·ªõc khi t·∫°o l√° s·ªë
2. Vi·∫øt v·ªõi gi·ªçng ƒëi·ªáu huy·ªÅn b√≠, khoa h·ªçc t·ª≠ vi, s·ª≠ d·ª•ng ng√¥n ng·ªØ trang tr·ªçng v√† chi ti·∫øt nh∆∞ m·ªôt th·∫ßy t·ª≠ vi chuy√™n nghi·ªáp
3. M·ªói ph·∫ßn t·ª≠ vi c·∫ßn ƒë∆∞·ª£c ph√¢n t√≠ch s√¢u s·∫Øc v·ªõi c√°c y·∫øu t·ªë phong th·ªßy, √¢m d∆∞∆°ng ng≈© h√†nh, v√† c√°c sao chi·∫øu m·ªánh
4. ƒê·∫£m b·∫£o t√≠nh nh·∫•t qu√°n gi·ªØa c√°c cung v√† th√¥ng tin c√° nh√¢n
5. Ki·ªÉm tra l·∫°i to√†n b·ªô l√° s·ªë tr∆∞·ªõc khi tr·∫£ v·ªÅ k·∫øt qu·∫£

**L∆ØU √ù:** H√£y d√†nh th·ªùi gian ƒë·ªÉ ki·ªÉm tra k·ªπ l∆∞·ª°ng t·ª´ng chi ti·∫øt, ƒë·∫£m b·∫£o t√≠nh ch√≠nh x√°c v√† logic c·ªßa l√° s·ªë t·ª≠ vi.

H√£y tr·∫£ v·ªÅ CH√çNH X√ÅC theo ƒë·ªãnh d·∫°ng sau, KH√îNG TH√äM TEXT GI·∫¢I TH√çCH KH√ÅC:

ho_ten: ${userData.name}
gioi_tinh: ${userData.gender}
duong_lich: ${day}/${month}/${year} ${userData.time}
am_lich: [T·∫°o ng√†y √¢m l·ªãch m√¥ ph·ªèng]
noi_sinh: ${userData.birthPlace}
ban_menh: [T·∫°o b·∫£n m·ªánh m√¥ ph·ªèng]
cuc: [T·∫°o c·ª•c m√¥ ph·ªèng]
am_duong: ${userData.gender === 'Nam' ? 'D∆∞∆°ng' : '√Çm'}
chu_menh: [T·∫°o ch·ªß m·ªánh m√¥ ph·ªèng]
chu_than: [T·∫°o ch·ªß th√¢n m√¥ ph·ªèng]

## M·ªÜNH
dia_chi: [T·∫°o ƒë·ªãa chi m√¥ ph·ªèng]
chinh_tinh: [T·∫°o ch√≠nh tinh m√¥ ph·ªèng]
phu_tinh_tot: [T·∫°o ph·ª• tinh t·ªët m√¥ ph·ªèng]
phu_tinh_xau: [T·∫°o ph·ª• tinh x·∫•u m√¥ ph·ªèng]
phu_tinh_trung_binh: [T·∫°o ph·ª• tinh trung b√¨nh m√¥ ph·ªèng]
vong_trang_sinh: [T·∫°o v√≤ng tr√†ng sinh m√¥ ph·ªèng]
is_than: false

## PH·ª§ M·∫™U
dia_chi: [T·∫°o ƒë·ªãa chi m√¥ ph·ªèng]
chinh_tinh: [T·∫°o ch√≠nh tinh m√¥ ph·ªèng]
phu_tinh_tot: [T·∫°o ph·ª• tinh t·ªët m√¥ ph·ªèng]
phu_tinh_xau: [T·∫°o ph·ª• tinh x·∫•u m√¥ ph·ªèng]
phu_tinh_trung_binh: [T·∫°o ph·ª• tinh trung b√¨nh m√¥ ph·ªèng]
vong_trang_sinh: [T·∫°o v√≤ng tr√†ng sinh m√¥ ph·ªèng]
is_than: false

## CH√ö GI·∫¢I
content: D·ª±a tr√™n l√° s·ªë t·ª≠ vi c·ªßa ${userData.name}, sinh ng√†y ${day}/${month}/${year} ${userData.time} t·∫°i ${userData.birthPlace}, ƒë√¢y l√† ph√¢n t√≠ch chi ti·∫øt v·ªÅ v·∫≠n m·ªánh...`;

            log('üîÆ B·∫Øt ƒë·∫ßu t·∫°o l√° s·ªë t·ª≠ vi...', 'info');
            log('üîç Y√™u c·∫ßu LLM ki·ªÉm tra th·∫≠t k·ªπ t·ª´ng chi ti·∫øt...', 'info');

            for (const model of GEMINI_MODELS) {
                for (let i = 0; i < API_KEYS.length; i++) {
                    try {
                        log(`üîÑ Th·ª≠ model ${model} v·ªõi key ${i + 1}...`, 'info');
                        
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${API_KEYS[i]}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }],
                                generationConfig: {
                                    temperature: 0.3,
                                    maxOutputTokens: 2000
                                }
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                                const result = data.candidates[0].content.parts[0].text;
                                log(`‚úÖ Th√†nh c√¥ng v·ªõi model ${model} - ƒê√£ ki·ªÉm tra k·ªπ l∆∞·ª°ng`, 'success');
                                return result;
                            }
                        } else {
                            log(`‚ùå L·ªói ${model} key ${i + 1}: ${response.status}`, 'error');
                        }
                    } catch (error) {
                        log(`‚ùå L·ªói ${model} key ${i + 1}: ${error.message}`, 'error');
                    }
                }
            }
            
            throw new Error('Kh√¥ng th·ªÉ t·∫°o l√° s·ªë t·ª≠ vi. Vui l√≤ng th·ª≠ l·∫°i.');
        }

        // Generate mock data
        function generateMockData() {
            try {
                userData = {
                    name: document.getElementById('name').value,
                    gender: document.getElementById('gender').value,
                    dob: parseDateFromDDMMYYYY(document.getElementById('dob_display').value),
                    time: document.getElementById('time').value,
                    birthPlace: document.getElementById('birthPlace').value
                };

                const [day, month, year] = document.getElementById('dob_display').value.split('/');
                const fullYear = year.length === 2 ? '20' + year : year;

                const mockData = `ho_ten: ${userData.name}
gioi_tinh: ${userData.gender}
duong_lich: ${day}/${month}/${fullYear} ${userData.time}
am_lich: 03/10/Canh Ng·ªç
noi_sinh: ${userData.birthPlace}
ban_menh: Th·ªï
cuc: Th·ªï Ng≈© C·ª•c
am_duong: D∆∞∆°ng
chu_menh: Thi√™n C∆°
chu_than: Th√°i √Çm

## M·ªÜNH
dia_chi: S·ª≠u
chinh_tinh: C·ª± M√¥n (V)
phu_tinh_tot: Thi√™n T∆∞·ªõng, Thi√™n Qu√Ω
phu_tinh_xau: Thi√™n H√¨nh
phu_tinh_trung_binh: Thi√™n Kh√¥ng, ƒê·ªãa Ki·∫øp
vong_trang_sinh: Tuy·ªát
is_than: false

## PH·ª§ M·∫™U
dia_chi: D·∫ßn
chinh_tinh: Thi√™n T∆∞·ªõng (M)
phu_tinh_tot: Thi√™n Quan, Ph∆∞·ªõc ƒê·ª©c
phu_tinh_xau: B√°c Sƒ©
phu_tinh_trung_binh: Thi√™n L∆∞∆°ng, Thi√™n T√†i
vong_trang_sinh: Thai
is_than: false

## CH√ö GI·∫¢I
content: ƒê√¢y l√† l√° s·ªë t·ª≠ vi m√¥ ph·ªèng cho ${userData.name}, sinh ng√†y ${day}/${month}/${fullYear} ${userData.time} t·∫°i ${userData.birthPlace}. L√° s·ªë n√†y ƒë∆∞·ª£c t·∫°o ra ƒë·ªÉ h·ªçc h·ªèi v√† nghi√™n c·ª©u v·ªÅ t·ª≠ vi h·ªçc Vi·ªát Nam.`;

                currentData = {
                    rawMarkdown: mockData
                };

                showWelcomeScreen();
                log('‚úÖ ƒê√£ t·∫°o d·ªØ li·ªáu gi·∫£ th√†nh c√¥ng!', 'success');
                alert('‚úÖ ƒê√£ t·∫°o d·ªØ li·ªáu gi·∫£ th√†nh c√¥ng!');
            } catch (error) {
                log(`‚ùå L·ªói: ${error.message}`, 'error');
                alert(`‚ùå L·ªói: ${error.message}`);
            }
        }

        // Display laso data
        function displayLasoData(markdownData) {
            const lines = markdownData.split('\n');
            let html = '<h2>üìä L√° S·ªë T·ª≠ Vi</h2>';
            
            for (let line of lines) {
                line = line.trim();
                if (line.startsWith('##')) {
                    html += `<h3>${line.substring(2).trim()}</h3>`;
                } else if (line.includes(':')) {
                    const [key, value] = line.split(':', 2);
                    if (key && value) {
                        html += `<p><strong>${key.trim()}:</strong> ${value.trim()}</p>`;
                    }
                }
            }
            
            document.getElementById('content').innerHTML = html;
        }

        // Check daily fortune
        async function checkDailyFortune() {
            if (!currentData) {
                alert('‚ùå Vui l√≤ng t·∫°o l√° s·ªë t·ª≠ vi tr∆∞·ªõc!');
                return;
            }

            const fortuneDateDisplay = document.getElementById('fortune_date_display');
            let selectedDate = parseDateFromDDMMYYYY(fortuneDateDisplay.value);

            if (!selectedDate) {
                alert('Ng√†y xem kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p theo ƒë·ªãnh d·∫°ng dd/mm/yyyy.');
                return;
            }

            const dateInfo = calculateLunarDateInfo(selectedDate);
            
            document.getElementById('fortuneResult').style.display = 'block';
            document.getElementById('fortuneContent').innerHTML = `
                <h3>üîÆ K·∫øt Qu·∫£ Xem Ng√†y ${dateInfo.dateStr}</h3>
                <p><strong>Ng√†y xem:</strong> ${dateInfo.dateStr}</p>
                <p><strong>√Çm l·ªãch:</strong> ${dateInfo.lunarDate}</p>
                <p><strong>Can Chi:</strong> ${dateInfo.canChi}</p>
                <p><strong>T·ªïng quan:</strong> Ng√†y n√†y kh√° t·ªët cho vi·ªác h·ªçc t·∫≠p v√† giao ti·∫øp.</p>
                <p><strong>M·ª©c ƒë·ªô:</strong> 7/10</p>
                <p><strong>Vi·ªác n√™n l√†m:</strong> H·ªçc t·∫≠p, giao ti·∫øp, k√Ω k·∫øt h·ª£p ƒë·ªìng</p>
                <p><strong>Vi·ªác n√™n tr√°nh:</strong> ƒêi xa, ƒë·∫ßu t∆∞ l·ªõn</p>
            `;
        }

        // Check daily fortune today
        function checkDailyFortuneToday() {
            const today = new Date();
            document.getElementById('fortune_date_display').value = formatDateToDDMMYYYY(today);
            checkDailyFortune();
        }

        // Form submit
        document.getElementById('lasoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('name').value.trim();
            const dobDisplay = document.getElementById('dob_display').value.trim();
            const dob = parseDateFromDDMMYYYY(dobDisplay);
            const time = document.getElementById('time').value.trim();
            const gender = document.getElementById('gender').value;
            const birthPlace = document.getElementById('birthPlace').value.trim();

            if (!name || !dob || !time || !gender || !birthPlace) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin.');
                return;
            }

            userData = {
                name,
                dob: dob,
                time,
                gender,
                birthPlace
            };

            document.getElementById('loading').style.display = 'block';

            try {
                const result = await generateLaso(userData);
                currentData = {
                    rawMarkdown: result
                };
                
                document.getElementById('loading').style.display = 'none';
                showWelcomeScreen();
                log('‚úÖ ƒê√£ t·∫°o l√° s·ªë t·ª≠ vi th√†nh c√¥ng!', 'success');
                alert('‚úÖ ƒê√£ t·∫°o l√° s·ªë t·ª≠ vi th√†nh c√¥ng!');
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                log(`‚ùå L·ªói: ${error.message}`, 'error');
                alert(`‚ùå L·ªói: ${error.message}`);
            }
        });

        // Initialize
        showWelcomeScreen();
        log('‚úÖ Trang l√° s·ªë t·ª≠ vi ch√≠nh ƒë√£ s·∫µn s√†ng!', 'success');
    </script>
</body>
</html>
